<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>FeatureBench Task Viewer</title>
    <link rel="icon" type="image/jpeg" href="../leaderboard/logos/logo.jpg" />
    <meta name="description" content="Rendered FeatureBench task markdown viewer." />
    <script>
      (() => {
        let stored = null;
        try {
          stored = localStorage.getItem("featurebench.theme");
        } catch {
          stored = null;
        }
        const prefersDark =
          window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
        const theme =
          stored === "dark" || stored === "light" ? stored : prefersDark ? "dark" : "light";
        document.documentElement.dataset.theme = theme;
      })();
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;600;700;800&family=Plus+Jakarta+Sans:wght@500;600;700;800&family=IBM+Plex+Mono:wght@500;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../assets/css/topbar.css" />
    <style>
      :root {
        color-scheme: light;
        --bg: #f7f8fb;
        --surface: #ffffff;
        --surface-soft: #f6f8fc;
        --text: #0f1728;
        --muted: #5c677d;
        --line: #dde4ef;
        --line-strong: #c7d1e0;
        --focus: #2f5dff;
        --font-ui: "Manrope", "Segoe UI", -apple-system, BlinkMacSystemFont, sans-serif;
        --font-head: "Plus Jakarta Sans", "Manrope", "Segoe UI", -apple-system, BlinkMacSystemFont, sans-serif;
        --font-mono: "IBM Plex Mono", "SFMono-Regular", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      }

      html[data-theme="dark"] {
        color-scheme: dark;
        --bg: #0b1220;
        --surface: #101a2c;
        --surface-soft: #14233a;
        --text: #e8eefb;
        --muted: #9eacc5;
        --line: #253750;
        --line-strong: #36547c;
        --focus: #8db0ff;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        min-height: 100%;
      }

      body {
        font-family: var(--font-ui);
        color: var(--text);
        background:
          radial-gradient(920px 520px at 8% -24%, rgba(72, 108, 240, 0.13), transparent 70%),
          radial-gradient(760px 460px at 92% -22%, rgba(57, 103, 255, 0.1), transparent 72%),
          var(--bg);
      }

      .shell {
        width: 100%;
      }

      main {
        width: min(1040px, 100% - 28px);
        margin: 30px auto 80px;
      }

      .viewer-nav {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 14px;
      }

      .viewer-nav a {
        display: inline-flex;
        align-items: center;
        height: 30px;
        border: 1px solid var(--line);
        color: var(--text);
        text-decoration: none;
        font-family: var(--font-mono);
        font-size: 12px;
        line-height: 1;
        padding: 0 10px;
        background: color-mix(in srgb, var(--surface) 96%, var(--surface-soft) 4%);
      }

      .viewer-nav a:hover {
        border-color: var(--line-strong);
      }

      .viewer-nav a:focus-visible {
        outline: 2px solid var(--focus);
        outline-offset: 2px;
      }

      .viewer-head {
        border: 1px solid var(--line);
        background: color-mix(in srgb, var(--surface) 97%, var(--surface-soft) 3%);
        padding: 14px 16px 16px;
      }

      .viewer-meta {
        margin: 0;
        color: var(--muted);
        font-family: var(--font-mono);
        font-size: 12px;
        line-height: 1.4;
      }

      .viewer-head h1 {
        margin: 8px 0 0;
        font-family: var(--font-head);
        font-size: clamp(1.1rem, 2vw, 1.6rem);
        line-height: 1.2;
        letter-spacing: -0.015em;
      }

      .markdown-body {
        margin-top: 0;
        border: 1px solid var(--line);
        border-top: 0;
        background: color-mix(in srgb, var(--surface) 98%, var(--surface-soft) 2%);
        padding: clamp(16px, 2vw, 24px);
        font-size: 0.95rem;
        line-height: 1.62;
      }

      .markdown-body > :first-child {
        margin-top: 0;
      }

      .markdown-body > :last-child {
        margin-bottom: 0;
      }

      .markdown-body h1,
      .markdown-body h2,
      .markdown-body h3,
      .markdown-body h4,
      .markdown-body h5,
      .markdown-body h6 {
        font-family: var(--font-head);
        line-height: 1.24;
        letter-spacing: -0.015em;
        margin: 1.2em 0 0.45em;
      }

      .markdown-body h1 {
        font-size: 1.45rem;
      }

      .markdown-body h2 {
        font-size: 1.25rem;
      }

      .markdown-body h3 {
        font-size: 1.1rem;
      }

      .markdown-body p {
        margin: 0.7em 0;
      }

      .markdown-body ul,
      .markdown-body ol {
        margin: 0.75em 0;
        padding-left: 1.4em;
      }

      .markdown-body li {
        margin: 0.22em 0;
      }

      .markdown-body code {
        font-family: var(--font-mono);
        font-size: 0.88em;
        border: 1px solid var(--line);
        background: color-mix(in srgb, var(--surface-soft) 82%, transparent 18%);
        padding: 0.08em 0.32em;
      }

      .markdown-body pre {
        margin: 0.95em 0;
        padding: 12px 14px;
        border: 1px solid var(--line);
        background: color-mix(in srgb, var(--surface-soft) 90%, transparent 10%);
        overflow: auto;
      }

      .markdown-body pre code {
        border: 0;
        background: transparent;
        padding: 0;
        font-size: 0.86em;
      }

      .markdown-body hr {
        border: 0;
        border-top: 1px solid var(--line);
        margin: 1.2em 0;
      }

      .markdown-body a {
        color: inherit;
        text-decoration-thickness: 1px;
        text-underline-offset: 2px;
      }

      .markdown-body .loading,
      .markdown-body .error {
        color: var(--muted);
        font-family: var(--font-mono);
      }

      @media (max-width: 760px) {
        main {
          width: min(1040px, 100% - 16px);
        }

        .viewer-nav {
          flex-wrap: wrap;
        }
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <header class="topbar">
        <div class="topbar-content">
          <div class="topbar-left">
            <a class="brand-home" href="../">
              <img src="../leaderboard/logos/logo.jpg" alt="FeatureBench fox logo" />
              <span>FeatureBench</span>
            </a>

            <nav class="main-nav" aria-label="Primary">
              <a href="../leaderboard/">Leaderboard</a>
              <a href="./" aria-current="page">Tasks</a>
              <a href="../news/">News</a>
            </nav>
          </div>

          <div class="topbar-right" aria-label="Theme and links">
            <button class="icon-btn" id="themeLight" type="button" aria-label="Use light theme" aria-pressed="false" title="Light">
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <circle cx="12" cy="12" r="4.5" stroke="currentColor" stroke-width="1.9" />
                <path
                  d="M12 2.5v2.3M12 19.2v2.3M4.9 4.9l1.6 1.6M17.5 17.5l1.6 1.6M2.5 12h2.3M19.2 12h2.3M4.9 19.1l1.6-1.6M17.5 6.5l1.6-1.6"
                  stroke="currentColor"
                  stroke-width="1.9"
                  stroke-linecap="round"
                />
              </svg>
            </button>
            <button class="icon-btn" id="themeDark" type="button" aria-label="Use dark theme" aria-pressed="false" title="Dark">
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path
                  d="M20 14.4a8.7 8.7 0 1 1-10.4-10.4A7 7 0 0 0 20 14.4Z"
                  stroke="currentColor"
                  stroke-width="1.9"
                  stroke-linejoin="round"
                />
              </svg>
            </button>
            <a
              class="icon-btn"
              href="https://github.com/LiberCoders/FeatureBench"
              target="_blank"
              rel="noopener noreferrer"
              aria-label="Open GitHub"
              title="GitHub"
            >
              <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path
                  d="M12 .5a12 12 0 0 0-3.79 23.39c.6.11.82-.26.82-.58v-2.2c-3.34.73-4.04-1.42-4.04-1.42-.55-1.39-1.33-1.76-1.33-1.76-1.09-.74.09-.73.09-.73 1.2.08 1.83 1.23 1.83 1.23 1.08 1.84 2.82 1.31 3.5 1 .11-.78.42-1.31.76-1.61-2.67-.3-5.47-1.34-5.47-5.95 0-1.31.47-2.39 1.23-3.23-.12-.31-.53-1.54.12-3.21 0 0 1.01-.32 3.3 1.23A11.4 11.4 0 0 1 12 6.8c1.01 0 2.03.14 2.98.42 2.29-1.55 3.3-1.23 3.3-1.23.65 1.67.24 2.9.12 3.21.77.84 1.23 1.92 1.23 3.23 0 4.62-2.81 5.64-5.49 5.94.43.38.81 1.13.81 2.28v3.38c0 .32.22.7.82.58A12 12 0 0 0 12 .5Z"
                />
              </svg>
            </a>
          </div>
        </div>
      </header>

      <main>
        <div class="viewer-nav">
          <a href="./" id="backToTasks">Back to Tasks</a>
          <a href="#" id="rawLink" target="_blank" rel="noopener noreferrer">Open Raw .md</a>
        </div>

        <section class="viewer-head">
          <p class="viewer-meta" id="taskMeta">Loading task metadata...</p>
          <h1 id="taskTitle">Loading...</h1>
        </section>

        <article class="markdown-body" id="markdownContent">
          <p class="loading">Loading markdown...</p>
        </article>
      </main>
    </div>

    <script>
      (function () {
        const root = document.documentElement;
        const lightBtn = document.getElementById("themeLight");
        const darkBtn = document.getElementById("themeDark");
        const themeStorageKey = "featurebench.theme";

        const rawLink = document.getElementById("rawLink");
        const taskMeta = document.getElementById("taskMeta");
        const taskTitle = document.getElementById("taskTitle");
        const markdownContent = document.getElementById("markdownContent");

        function applyTheme(theme) {
          const safe = theme === "dark" ? "dark" : "light";
          root.dataset.theme = safe;
          lightBtn.classList.toggle("active", safe === "light");
          darkBtn.classList.toggle("active", safe === "dark");
          lightBtn.setAttribute("aria-pressed", safe === "light" ? "true" : "false");
          darkBtn.setAttribute("aria-pressed", safe === "dark" ? "true" : "false");
          try {
            localStorage.setItem(themeStorageKey, safe);
          } catch {
            // ignore
          }
        }

        function initTheme() {
          let stored = "light";
          try {
            stored = localStorage.getItem(themeStorageKey) || "light";
          } catch {
            stored = "light";
          }
          if (stored !== "dark" && stored !== "light") {
            stored = "light";
          }
          applyTheme(stored);
        }

        function escapeHtml(value) {
          return String(value)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#39;");
        }

        function sanitizeUrl(url) {
          const trimmed = String(url || "").trim();
          if (/^(https?:|mailto:|#|\.{1,2}\/|\/)/i.test(trimmed)) {
            return trimmed;
          }
          return "#";
        }

        function renderInline(value) {
          let html = escapeHtml(value);
          const codeSnippets = [];

          html = html.replace(/`([^`]+)`/g, (_, code) => {
            const token = "%%CODE_" + codeSnippets.length + "%%";
            codeSnippets.push("<code>" + escapeHtml(code) + "</code>");
            return token;
          });

          html = html.replace(/\[([^\]]+)\]\(([^)\s]+)\)/g, (_, text, url) => {
            const safeText = text;
            const safeUrl = sanitizeUrl(url);
            const attrs = /^https?:/i.test(safeUrl)
              ? ' target="_blank" rel="noopener noreferrer"'
              : "";
            return '<a href="' + safeUrl + '"' + attrs + ">" + safeText + "</a>";
          });

          html = html.replace(/\*\*([^*]+)\*\*/g, "<strong>$1</strong>");
          html = html.replace(/\*([^*]+)\*/g, "<em>$1</em>");

          html = html.replace(/%%CODE_(\d+)%%/g, (_, idx) => codeSnippets[Number(idx)] || "");
          return html;
        }

        function renderMarkdown(md) {
          const fencedBlocks = [];
          const fencedSource = md.replace(/```([a-zA-Z0-9_-]*)\n([\s\S]*?)```/g, (_, lang, code) => {
            const token = "%%BLOCK_" + fencedBlocks.length + "%%";
            const className = lang ? ' class="language-' + escapeHtml(lang) + '"' : "";
            const block =
              "<pre><code" + className + ">" + escapeHtml(code.replace(/\n$/, "")) + "</code></pre>";
            fencedBlocks.push(block);
            return token;
          });

          const lines = fencedSource.split(/\r?\n/);
          const out = [];
          let i = 0;

          function lineAt(index) {
            return lines[index] || "";
          }

          function pushParagraph(startIndex) {
            const parts = [];
            let j = startIndex;
            while (j < lines.length) {
              const line = lineAt(j);
              const trimmed = line.trim();
              if (!trimmed) break;
              if (/^%%BLOCK_\d+%%$/.test(trimmed)) break;
              if (/^\s{0,3}#{1,6}\s+/.test(line)) break;
              if (/^\s*[-*+]\s+/.test(line)) break;
              if (/^\s*\d+\.\s+/.test(line)) break;
              if (/^\s{0,3}([-*_])(\s*\1){2,}\s*$/.test(line)) break;
              parts.push(trimmed);
              j += 1;
            }
            if (parts.length > 0) {
              out.push("<p>" + renderInline(parts.join(" ")) + "</p>");
            }
            return j;
          }

          while (i < lines.length) {
            const line = lineAt(i);
            const trimmed = line.trim();

            if (!trimmed) {
              i += 1;
              continue;
            }

            if (/^%%BLOCK_\d+%%$/.test(trimmed)) {
              const idx = Number(trimmed.replace("%%BLOCK_", "").replace("%%", ""));
              out.push(fencedBlocks[idx] || "");
              i += 1;
              continue;
            }

            const headingMatch = line.match(/^\s{0,3}(#{1,6})\s+(.*)$/);
            if (headingMatch) {
              const level = Math.min(6, headingMatch[1].length);
              out.push("<h" + level + ">" + renderInline(headingMatch[2].trim()) + "</h" + level + ">");
              i += 1;
              continue;
            }

            if (/^\s{0,3}([-*_])(\s*\1){2,}\s*$/.test(line)) {
              out.push("<hr />");
              i += 1;
              continue;
            }

            if (/^\s*[-*+]\s+/.test(line)) {
              const listItems = [];
              let j = i;
              while (j < lines.length && /^\s*[-*+]\s+/.test(lineAt(j))) {
                const text = lineAt(j).replace(/^\s*[-*+]\s+/, "");
                listItems.push("<li>" + renderInline(text.trim()) + "</li>");
                j += 1;
              }
              out.push("<ul>" + listItems.join("") + "</ul>");
              i = j;
              continue;
            }

            if (/^\s*\d+\.\s+/.test(line)) {
              const listItems = [];
              let j = i;
              while (j < lines.length && /^\s*\d+\.\s+/.test(lineAt(j))) {
                const text = lineAt(j).replace(/^\s*\d+\.\s+/, "");
                listItems.push("<li>" + renderInline(text.trim()) + "</li>");
                j += 1;
              }
              out.push("<ol>" + listItems.join("") + "</ol>");
              i = j;
              continue;
            }

            i = pushParagraph(i);
          }

          return out.join("");
        }

        function sanitizePath(rawPath) {
          let value = String(rawPath || "").trim();
          if (!value) return null;
          value = value.replace(/\\/g, "/");
          if (/^[a-z]+:\/\//i.test(value)) return null;
          if (value.startsWith("/")) return null;
          if (value.includes("..")) return null;
          if (!value.startsWith("./")) {
            value = "./" + value.replace(/^\.?\//, "");
          }
          if (!value.startsWith("./data/lite/") && !value.startsWith("./data/full/")) {
            return null;
          }
          if (!value.endsWith(".md")) {
            return null;
          }
          return value;
        }

        function showError(message) {
          taskTitle.textContent = "Could not load task statement";
          markdownContent.innerHTML = '<p class="error">' + escapeHtml(message) + "</p>";
        }

        async function initViewer() {
          const params = new URLSearchParams(window.location.search);
          const safePath = sanitizePath(params.get("path"));

          if (!safePath) {
            showError("Missing or invalid markdown path.");
            taskMeta.textContent = "Invalid request";
            rawLink.setAttribute("aria-disabled", "true");
            rawLink.removeAttribute("href");
            return;
          }

          const split = params.get("split") || "";
          const repo = params.get("repo") || "";
          const caseId = params.get("case") || "";
          const title = params.get("title") || caseId || "Task statement";

          taskTitle.textContent = title;
          taskMeta.textContent =
            [split ? split.toUpperCase() : "", repo, caseId].filter(Boolean).join("  |  ") || "Task";

          rawLink.href = safePath;

          try {
            const response = await fetch(safePath, { cache: "no-store" });
            if (!response.ok) {
              throw new Error("HTTP " + response.status);
            }
            const markdown = await response.text();
            markdownContent.innerHTML = renderMarkdown(markdown);
          } catch (error) {
            showError("Failed to read markdown file: " + error.message);
            console.error(error);
          }
        }

        initTheme();
        lightBtn.addEventListener("click", () => applyTheme("light"));
        darkBtn.addEventListener("click", () => applyTheme("dark"));
        initViewer();
      })();
    </script>
  </body>
</html>
